---
title: "Health Predictions"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
css: styles.css
---

```{r setup, include=FALSE}

### To change to new data set, replace penguins everywhere :) 
library(flexdashboard)
library(palmerpenguins)
library(caret) 
library(DT)
library(ggplot2)
library(sortable)
library(modelr)

# Questions: 
# 1. do we want some kind of train/val/test split? 
# 2. When we use reactive data rendering, can we modify the data once? 
train_dataset = read.csv("train_data.csv", header = TRUE ,sep = ",")
test_dataset = read.csv('test_data.csv', header=TRUE, sep=',')

exists("train_dataset")
exists("test_dataset")
TOTAL_BUDGET = 1000000
COST_PER_ROW = 25
```


Build model
=====================================  
  


Column {data-width=300}
----------------------------------------------------------------------- 

```{r}
  sliderInput('sampleSize', 'Size of Training Dataset', min=100, max=min(nrow(train_dataset), TOTAL_BUDGET/COST_PER_ROW),
            value=100, step=500, round=0)

  bucket_list(
        header = "Drag variables to build your model",
        group_name = "bucket_list_group",
        orientation = "vertical",
        add_rank_list(
          text = "Not used",
          # change the variable names
          labels = names(train_dataset),
          input_id = "out_model"
        ),
        add_rank_list(
          text = "Used",
          labels = NULL,
          input_id = "in_model"
        )
      )
```



Column {data-width=400, data-height=300}
-----------------------------------------------------------------------

### Predictions vs truth

```{r}

usable_train_dataset <- reactive({
  train_dataset[1:input$sampleSize,]
})


model1 <- reactive({
  if(length(input$in_model) > 0){
    #change this to new data
    ###change the hyphen to underscore
    # does this make an edit
    lm1 = lm(as.formula(paste0("Chronic_illnesses ~ ",paste0(input$in_model,collapse="+"))),
         data=usable_train_dataset())
  }else{
    # change to new data
    lm1 = lm(Chronic_illnesses ~ 1,data=usable_train_dataset())
  }
  
})

renderPlot({ 
  
   # changed to new data
test_dataset %>%
    add_predictions(model1()) %>%
    ggplot(aes_string(x="Chronic_illnesses",y="pred")) +
    geom_point()

})
```

### RMSE

```{r}
renderText({
 sqrt(sum(model1()$residuals^2))
})
```

### Remaining budget

```{r}
renderText({
 paste('$', TOTAL_BUDGET - input$sampleSize * COST_PER_ROW)
})
```




Data Description/Dictionary
===================================== 
Predictor: Chronic_illnesses

Factors:

* Normal_mean_creatinine- An indicator of kidney function
* Normal_mean_hematocrit - Red blood cell count
* Normal_mean_GHbA1c - Plasma glucose; used to diagnose diabetes
* Normal_mean_LDL - Low denisty lipids; used to evaluate cholestorol 
* Normal_mean_BNP - Brain natriuretic peptide; indicates risk of heart failure
* Normal_mean_sodiumm - could indicate heart failure or kidney disease
* Normal_mean_triglycerides - could indicate risk of diabetes or heart disease


Health Data
===================================== 


```{r}
datatable(test_dataset,fillContainer = FALSE) 
```


Explore Health Data
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------



```{r}
   # changed to new data
radioButtons("plottype", h4("Plot type"),
                        choices = c("scatterplot","boxplot"),selected="scatterplot")

selectInput("xvariable", h4("Pick x-variable"),
                        choices = colnames(test_dataset), selected="trig_mean_normal_tm1")

selectInput("yvariable", h4("Pick y-variable"),
                        choices = colnames(test_dataset), selected="Chronic_illnesses")

```

Column 
-----------------------------------------------------------------------

### Health plot

```{r}

# change to new data
renderPlot(
  if(input$plottype=="scatterplot"){
    test_dataset %>% 
      ggplot(aes_string(x=input$xvariable,y=input$yvariable)) + geom_point()
  }else{
    test_dataset %>% 
      ggplot(aes_string(x=input$xvariable,y=input$yvariable)) + geom_boxplot()
  }
)
```



